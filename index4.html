<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Taha's Website</title>
    <style>
        html, body {
            margin: 0;
            padding: 0;
            height: 100%;
            overflow-x: hidden;
            scroll-behavior: smooth;
        }

        body {
            background: #ffffff;
            height: 200vh;
        }

        canvas {
            position: fixed;
            left: 0;
            top: 0;
            width: 100vw;
            height: 100vh;
            object-fit: cover;
        }
    </style>
</head>
<body>
    <h1 style="color: #b7b7b7;">Welcome to My JavaScript Website</h1>

    <canvas id="canvas"></canvas>
    <div id="overlay" style="position: fixed; top: 30%; left: 50%; transform: translate(-50%, -50%); color: white; font-size: 160px; transition: opacity 0.1s; opacity: 1; z-index: 10;">
        Taha's Pen
    </div>

    <script>
        console.log('Script started');

        const canvas = document.getElementById('canvas');
        const context = canvas.getContext("2d");

        const currentFrame = index => `./render8k/${index.toString().padStart(4, '0')}.webp`;

        const frameCount = 143;
        const html = document.documentElement;
        let currentFrameIndex = 1;

        const img = new Image();

        const updateImage = index => {
            img.src = currentFrame(index);
            img.onload = function() {
                drawImageCovered(img, context, canvas.width, canvas.height);
            };
        };

        img.onerror = function() {
            console.error('Error loading image:', img.src);
        };

        // Function to draw image covering the canvas (cropping if necessary)
        function drawImageCovered(img, ctx, canvas_width, canvas_height) {
            const imgRatio = img.width / img.height;
            const canvasRatio = canvas_width / canvas_height;
            let drawWidth, drawHeight, offsetX, offsetY;

            if (imgRatio > canvasRatio) {
                drawHeight = canvas_height;
                drawWidth = img.width * (canvas_height / img.height);
                offsetX = (canvas_width - drawWidth) / 2;
                offsetY = 0;
            } else {
                drawWidth = canvas_width;
                drawHeight = img.height * (canvas_width / img.width);
                offsetX = 0;
                offsetY = (canvas_height - drawHeight) / 2;
            }

            ctx.drawImage(img, offsetX, offsetY, drawWidth, drawHeight);
        }

        // Resize canvas and redraw current frame after resizing
        const resizeCanvas = () => {
            canvas.width = window.innerWidth;
            canvas.height = window.innerHeight;
            if (img.complete) {
                drawImageCovered(img, context, canvas.width, canvas.height);
            }
        };

        window.addEventListener('resize', resizeCanvas);

        // Variables for inertia scrolling
        let scrollVelocity = 0;
        const inertiaFactor = 3;

        // Smooth scrolling using requestAnimationFrame (Debounce Scroll)
        let lastKnownScrollPosition = 0;
        let ticking = false;

        const handleScroll = () => {
            lastKnownScrollPosition = html.scrollTop;
            scrollVelocity = lastKnownScrollPosition - (scrollVelocity * inertiaFactor);

            if (!ticking) {
                window.requestAnimationFrame(() => {
                    const maxScrollTop = html.scrollHeight - window.innerHeight;
                    const scrollFraction = lastKnownScrollPosition / maxScrollTop;
                    const frameIndex = Math.min(
                        frameCount - 1,
                        Math.floor(scrollFraction * frameCount)
                    );

                    if (frameIndex + 1 !== currentFrameIndex) {
                        currentFrameIndex = frameIndex + 1;
                        updateImage(currentFrameIndex);
                    }

                    // Fade out the overlay text on scroll
                    const overlay = document.getElementById('overlay');
                    overlay.style.opacity = Math.max(0, 1 - scrollFraction * (frameCount / 17));

                    ticking = false;
                });
                ticking = true;
            }
        };

        window.addEventListener('scroll', handleScroll);

        // Preload the next few frames to make transitions smoother
        const preloadImages = () => {
            for (let i = 1; i < frameCount; i++) {
                const img = new Image();
                img.src = currentFrame(i);
            }
        };

        // Initial setup
        resizeCanvas();
        updateImage(currentFrameIndex);
        preloadImages();

        console.log('Script completed');
    </script>
</body>
</html>